<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Adjustment Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border-radius: 1rem; padding: 1.5rem; border: 1px solid #334155; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        input[type="number"], input[type="text"], input[type="file"] {
            background-color: #334155; border: 1px solid #475569; color: white; border-radius: 0.5rem; padding: 0.5rem 0.75rem; width: 100%;
        }
        input:focus { outline: 2px solid #3b82f6; border-color: transparent; }
        .preview-container { max-height: 400px; overflow: auto; border-radius: 0.5rem; background: #0f172a; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th { background: #334155; position: sticky; top: 0; padding: 0.75rem; text-align: left; z-index: 10; }
        td { padding: 0.75rem; border-bottom: 1px solid #334155; white-space: nowrap; }
        .highlight-j { color: #60a5fa; font-weight: bold; background-color: rgba(59, 130, 246, 0.05); }
        .highlight-r { color: #c084fc; font-weight: bold; background-color: rgba(168, 85, 247, 0.05); }
        .btn-primary { background-color: #2563eb; transition: all 0.2s; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: #16a34a; transition: all 0.2s; }
        .btn-success:hover { background-color: #15803d; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-400">CSV Adjustment Tool</h1>
            <p class="text-gray-400 mt-2">Intelligent CSV pricing updates based on field names and SKU patterns.</p>
        </header>

        <!-- Configuration Card -->
        <div class="card mb-8">
            <h2 class="text-2xl font-semibold mb-6 flex items-center">
                <i data-lucide="settings" class="w-6 h-6 mr-2 text-blue-400"></i> Configuration
            </h2>
            
            <div class="mb-8">
                <label for="csvFile" class="block text-sm font-medium mb-2 text-gray-300">1. Upload Source CSV File</label>
                <input type="file" id="csvFile" accept=".csv" class="w-full cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
            </div>

            <div class="grid grid-cols-1 gap-8 mb-8">
                <!-- Column J Control -->
                <div class="p-5 bg-slate-800/50 rounded-xl border border-slate-700">
                    <h3 class="text-lg font-medium text-blue-300 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center mr-2 text-sm text-blue-400 font-bold">J</span>
                        Column J Adjustments (Main Price)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1 uppercase tracking-wider">Increase % (If SKU contains "per-yard")</label>
                            <div class="relative">
                                <input type="number" id="adjJ" value="15" step="0.01">
                                <span class="absolute right-3 top-2 font-bold text-gray-500">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column R Controls -->
                <div class="p-5 bg-slate-800/50 rounded-xl border border-slate-700">
                    <h3 class="text-lg font-medium text-purple-300 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center mr-2 text-sm text-purple-400 font-bold">R</span>
                        Column R Adjustments (Custom JSON Fields)
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Field 1: Price per Yard -->
                        <div class="space-y-4">
                            <div class="text-xs font-bold text-purple-400 uppercase tracking-widest border-b border-purple-500/20 pb-1">Price Adjustments</div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1 uppercase">Field Name to Match</label>
                                <input type="text" id="fieldNamePrice" value="Price per Yard (CUSTOM COVERS ONLY)" class="text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1 uppercase">Increase %</label>
                                    <input type="number" id="adjRPrice" value="25" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-blue-400 mb-1 uppercase font-bold">Static $</label>
                                    <input type="number" id="staticRPrice" placeholder="Override" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Field 2: Cost to us -->
                        <div class="space-y-4">
                            <div class="text-xs font-bold text-purple-400 uppercase tracking-widest border-b border-purple-500/20 pb-1">Cost Adjustments</div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1 uppercase">Field Name to Match</label>
                                <input type="text" id="fieldNameCost" value="Cost to us per yard" class="text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1 uppercase">Increase %</label>
                                    <input type="number" id="adjRCost" value="40" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-blue-400 mb-1 uppercase font-bold">Static $</label>
                                    <input type="number" id="staticRCost" placeholder="Override" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Field 3: Fabric Only -->
                        <div class="space-y-4">
                            <div class="text-xs font-bold text-purple-400 uppercase tracking-widest border-b border-purple-500/20 pb-1">Fabric Cost Adjustments</div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1 uppercase">Field Name to Match</label>
                                <input type="text" id="fieldNameFabricCost" value="Cost (FABRIC ONLY)" class="text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] text-gray-500 mb-1 uppercase">Increase %</label>
                                    <input type="number" id="adjRFabricCost" value="0" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-blue-400 mb-1 uppercase font-bold">Static $</label>
                                    <input type="number" id="staticRFabricCost" placeholder="Override" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="runButton" class="flex-1 btn-primary px-6 py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center">
                    <i data-lucide="play" class="w-5 h-5 mr-2"></i> Run Adjustments
                </button>
                <button id="downloadButton" disabled class="flex-1 btn-success px-6 py-4 rounded-xl disabled:bg-gray-700 disabled:cursor-not-allowed font-bold text-white shadow-lg flex items-center justify-center">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download Result
                </button>
            </div>
            
            <p id="statusMessage" class="mt-6 text-center text-sm font-medium transition-all"></p>
        </div>

        <!-- Results Panel -->
        <div id="statsPanel" class="card mb-8 hidden border-green-500/30">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i data-lucide="bar-chart" class="w-6 h-6 mr-2 text-green-400"></i> Processing Results
            </h2>
            <div id="statsContent" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Preview Table -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 flex items-center text-purple-300">
                <i data-lucide="table" class="w-6 h-6 mr-2"></i> Results Preview (Top 15 Rows)
            </h2>
            <div id="previewContainer" class="preview-container">
                <div class="p-12 text-center text-gray-500">
                    <i data-lucide="file-spreadsheet" class="w-16 h-16 mx-auto mb-4 opacity-10"></i>
                    <p>Upload a file and run the tool to see changes here.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let originalData = null;
        let adjustedData = null;
        let headers = null;

        // Init icons
        lucide.createIcons();

        // DOM
        const fileInput = document.getElementById('csvFile');
        const runButton = document.getElementById('runButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusMessage = document.getElementById('statusMessage');
        const previewContainer = document.getElementById('previewContainer');
        const statsPanel = document.getElementById('statsPanel');
        const statsContent = document.getElementById('statsContent');

        // File loading
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusMessage.textContent = "Parsing CSV...";
            statusMessage.className = "mt-6 text-center text-blue-400";

            Papa.parse(file, {
                complete: function(results) {
                    originalData = results.data;
                    headers = results.data[0];
                    statusMessage.textContent = `Success: ${results.data.length - 1} rows loaded. Configure settings and click Run.`;
                    statusMessage.className = "mt-6 text-center text-green-400 font-bold";
                    downloadButton.disabled = true;
                    statsPanel.classList.add('hidden');
                },
                error: function(err) {
                    statusMessage.textContent = "Error parsing file: " + err.message;
                    statusMessage.className = "mt-6 text-center text-red-400";
                }
            });
        });

        // Processing Logic
        runButton.addEventListener('click', () => {
            if (!originalData) {
                statusMessage.textContent = "Error: Please select a CSV file first.";
                statusMessage.className = "mt-6 text-center text-red-400 font-bold";
                return;
            }

            statusMessage.textContent = "Calculating adjustments...";
            statusMessage.className = "mt-6 text-center text-blue-400 animate-pulse";

            // Multipliers
            const multJ = 1 + (parseFloat(document.getElementById('adjJ').value) || 0) / 100;
            const multRPrice = 1 + (parseFloat(document.getElementById('adjRPrice').value) || 0) / 100;
            const multRCost = 1 + (parseFloat(document.getElementById('adjRCost').value) || 0) / 100;
            const multRFabric = 1 + (parseFloat(document.getElementById('adjRFabricCost').value) || 0) / 100;

            // Static Overrides
            const sRPrice = document.getElementById('staticRPrice').value ? parseFloat(document.getElementById('staticRPrice').value) : null;
            const sRCost = document.getElementById('staticRCost').value ? parseFloat(document.getElementById('staticRCost').value) : null;
            const sRFabric = document.getElementById('staticRFabricCost').value ? parseFloat(document.getElementById('staticRFabricCost').value) : null;

            // Names
            const nPrice = document.getElementById('fieldNamePrice').value.trim();
            const nCost = document.getElementById('fieldNameCost').value.trim();
            const nFabric = document.getElementById('fieldNameFabricCost').value.trim();

            let countJ = 0, countRP = 0, countRC = 0, countRF = 0;

            adjustedData = originalData.map((row, idx) => {
                if (idx === 0 || !row || row.length < 5) return row; // Header or empty

                const newRow = [...row];

                // --- Column J Logic ---
                // BigCommerce SKU is usually index 4. Price is usually index 9.
                const sku = String(row[4] || "").toLowerCase();
                if (sku.includes('per-yard')) {
                    const currentPrice = parseFloat(row[9]);
                    if (!isNaN(currentPrice)) {
                        newRow[9] = (currentPrice * multJ).toFixed(2);
                        countJ++;
                    }
                }

                // --- Column R Logic (JSON) ---
                // Custom Fields is usually index 17
                const rawJSON = row[17];
                if (rawJSON && rawJSON.trim().startsWith('[')) {
                    try {
                        let fields = JSON.parse(rawJSON);
                        let changed = false;

                        fields = fields.map(field => {
                            const clean = (val) => parseFloat(String(val).replace(/[$,]/g, ''));
                            let finalVal = null;
                            let matched = false;

                            if (field.name === nPrice) {
                                matched = true;
                                finalVal = sRPrice !== null ? sRPrice : (clean(field.value) * multRPrice);
                                countRP++;
                            } else if (field.name === nCost) {
                                matched = true;
                                finalVal = sRCost !== null ? sRCost : (clean(field.value) * multRCost);
                                countRC++;
                            } else if (field.name === nFabric) {
                                matched = true;
                                finalVal = sRFabric !== null ? sRFabric : (clean(field.value) * multRFabric);
                                countRF++;
                            }

                            if (matched && !isNaN(finalVal)) {
                                field.value = `$${finalVal.toFixed(2)}`;
                                changed = true;
                            }
                            return field;
                        });

                        if (changed) newRow[17] = JSON.stringify(fields);
                    } catch (e) { console.warn("JSON error at row " + idx, e); }
                }

                return newRow;
            });

            // Update UI
            updateStats(countJ, countRP, countRC, countRF, adjustedData.length - 1);
            updatePreview(adjustedData.slice(0, 16));
            
            downloadButton.disabled = false;
            statusMessage.textContent = "Processing Finished! Review the preview below.";
            statusMessage.className = "mt-6 text-center text-green-400 font-bold";
        });

        function updateStats(j, rp, rc, rf, total) {
            statsPanel.classList.remove('hidden');
            const boxClass = "p-3 bg-slate-800 rounded-lg border border-slate-700 shadow-inner";
            const labelClass = "text-[10px] text-gray-500 uppercase font-bold";
            const valClass = "text-xl font-mono block";

            statsContent.innerHTML = `
                <div class="${boxClass}"><span class="${labelClass}">Total Rows</span><span class="${valClass} text-white">${total}</span></div>
                <div class="${boxClass}"><span class="${labelClass} text-blue-400">J: Per Yard</span><span class="${valClass} text-blue-400">${j}</span></div>
                <div class="${boxClass}"><span class="${labelClass} text-purple-400">R: Price Fields</span><span class="${valClass} text-purple-400">${rp}</span></div>
                <div class="${boxClass}"><span class="${labelClass} text-purple-400">R: Cost Fields</span><span class="${valClass} text-purple-400">${rc}</span></div>
                <div class="${boxClass}"><span class="${labelClass} text-purple-400">R: Fabric Cost</span><span class="${valClass} text-purple-400">${rf}</span></div>
            `;
        }

        function updatePreview(rows) {
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            rows.slice(1).forEach(row => {
                html += '<tr>';
                row.forEach((cell, i) => {
                    let cls = "";
                    if (i === 9) cls = "highlight-j";
                    if (i === 17) cls = "highlight-r";
                    
                    let val = String(cell);
                    if (i === 17 && val.length > 50) val = val.substring(0, 47) + "...";
                    
                    html += `<td class="${cls}">${val}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            previewContainer.innerHTML = html;
        }

        downloadButton.addEventListener('click', () => {
            const csv = Papa.unparse(adjustedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `adjusted_products_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
